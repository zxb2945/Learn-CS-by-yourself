# 鸟哥的Linux私房菜-服务器架设篇

## 1.架设服务器前的准备工作

架站需要很强的 Linux 基础概念以及基础网络知识

对于网络服务器来说最重要的基础档案权限、程序之启动关闭与管 理、 Bash shell 之操作与 script 、使用者账号的管理等等，您都必须要具备最基础 的认知才行

> Linux/Unix 的文件调用权限分为三级 : 文件所有者（Owner）、用户组（Group）、其它用户（Other Users）。
>
> | r    | 读       | 设置为可读权限   |
> | ---- | -------- | ---------------- |
> | w    | 写       | 设置为可写权限   |
> | x    | 执行权限 | 设置为可执行权限 |

## 2.基础网络概念

一组合理的网络设定需

 IP  Netmask  Network  Broadcast  Gateway  DNS

Network 与 Broadcast 可以经由 IP/Netmask 的计算而得到，因此需 要设定于你 PC 端的网络参数， 主要就是 IP, Netmask, Default Gateway, DNS 这四 个就是了！

## 3.局域网络架构简介

> proxy 服务器:代理服务器，可以通过其来实现防火墙功能与网络浏览数据分析等功能。
>

让 Linux 作为 IP 分享器的功能相当的简单，同时Linux 必须具备两张网络卡，分别是对外与对内.
该主机必须要具有 router 的能力，所以当然必须就要有两个接口，一个接口与 Internet 沟通，另一个接口则与内部的 LAN 沟通。那么为什么鸟哥说的是『两个网络接口』而不是『两张网络卡』呢？原因很简单， 因为一张网络卡可以设定多个 IP 啊！因此，在 Linux 当中一张网络卡可以具有一个以上的 IP 呢！由于一个 IP 即为一个网络接口，因此只要两个网络接口 (不论有几张网络卡) 即可进行 NAT (类似 IP 分享器功能) 的设定啦！所以自然一个网络卡即可啰！不过，鸟哥个人还是比较喜欢并且建议两张网络卡的啦， 将内外网络环境完整的分开，让你的内部网络效能较佳一点！

## 4.连上Internet

1. 取得官方网站的驱动程序
2. 解压缩与编译
3. 模块重载
4. 设定 IP 

hostname

1. IP/Netmask/Gateway 的设定、启动与观察
设定网络参数得要修改 /etc/sysconfig/network-scripts/ifcfg-eth0
2. DNS 服务器的 IP 设定与观察
3. 主机名的修改、启动与观察

可自动取得 IP 的环境是怎么回事啊？不是很简单吗？当你在 IP 分享器后头的主机在设定时，不是都会选择『自动取得 IP 』吗？那就是可自动取得 IP 的环境啦！那么这个自动取得是怎么回事啊？也不难了解啦，其实就是『有一部主机提供 DHCP 服务给整个网域内的计算机』就是了！例如 IP 分享器就可能是一部 DHCP 主机。那么DHCP 是啥？ 他是：Dynamic Host Configuration Protocol 的简写，顾名思义，他可以『动态的调整主机的网络参数』的意思。

线网络所需要的硬件： AP、无线网卡
我们知道在 RJ-45 的以太网络联机环境中，以 switch/hub 以及网络卡与网络线最重要，该架构中主要以 switch/hub 串接所有的网络设备。那么在无线网络中，当然也需要一个接收讯号的装置，那就是无线基地台 (Wireless Access Point, 简称 AP) 了！另一个装置当然就是安装在计算机主机上面的无线网卡啰！
其实无线基地台本身就是个 IP 分享器了，他本身会有两个接口，一个可以与外部的 IP 做沟通，另外一个则是作为 LAN 内部其他主机的 GATEWAY 啰！那其他主机上面只要安装了无线网卡，并且顺利的连上 AP 后，自然就可以透过 AP 来连上 Internet 啦！
『如果 AP 不设定任何联机限制，那任何拥有无线网卡的主机都可以透过这个 AP 连接上你的 LAN 』，要知道，通常我们都会认为 LAN 是信任网域，所以内部是没有防火墙的，亦即是不设防的状态，呵呵！ 如果刚好有人拿着笔记本电脑经过你的 AP 可以接收讯号的范围，那么他就可以轻易的透过你的 AP 连接上你的 LAN ，并且可以透过你的 AP 连上Internet ，如果他刚好是个喜欢搞破坏的 cracker ， 哈哈！那么当他使用你的 AP 去攻击别人时，最后被发现的跳板是谁？当然是你的 AP！ 那是谁会吃上官司？够清楚了吧？而且你内部主机的数据也很有可能被窃取啊！
Linux 以太网络卡的默认代号为 eth0, eth1 等等, 无线网卡则为 wlan0, ra0 等等；
最简单的方法就是『给予内部的主机每部主机一个名称与IP 的对应』即可。举例来说，我们知道每部主机都有一个主机名为 localhost ，对应到 127.0.0.1 ，为什么呢？因为这个 127.0.0.1 与 localhost 的对应就被到/etc/hosts 内嘛！ 当我们需要主机名与 IP 的对应时，系统就会先到 /etc/hosts 找寻对应的设定值， 如果找不到，才会使用 /etc/resolv.conf 的设定去因特网找。这样说，你明白了吧？ 也就是说，只要修改了 /etc/hosts，加入每部主机与 IP 的对应，就能够加快主机名的检查啰！所以说，你就要将你的 私有 IP 的计算机与计算机名称写入你的/etc/hosts 当中了！

## 5.Linux常用网络指令

ifup 与 ifdown 真是太简单了！这两支程序其实是 script 而已，他会直接到/etc/sysconfig/network-scripts 目录下搜寻对应的配置文件，例如 ifup eth0 时，他会找出 ifcfg-eth0 这个档案的内容，然后来加以设定。
route 与 route -n 的输出结果，你可以发现有加 -n 参数的主要是显示出 IP ，至于使用 route 而已的话，显示的则是『主机名』喔！
Gateway：该网域是通过哪个 gateway 连接出去的？如果显示 0.0.0.0 表示该路由是直接由本机传送，亦即可以透过局域网络的 MAC 直接传讯；如果有显示 IP 的话，表示该路由需要经过路由器 (通讯闸) 的帮忙才能够传送出去。
ip link show
如果说 ip link 是与 OSI 七层协定 的第二层资料连阶层有关的话，那么 ip address (ip addr) 就是与第三层网络层有关的参数啦！ 主要是在设定与 IP 有关的各项参数，包括 netmask, broadcast 等等。
 无线网络： iwlist, iwconfig

  netstat -tulnp
  -t ：仅列出 TCP 封包的联机；
 -u ：仅列出 UDP 封包的联机；
 -l ：仅列出有在 Listen (监听) 的服务之网络状态；
 -n ：不使用主机名与服务名称，使用 IP 与 port number ，如同 route -n与网络接口有关的参数：

上面最重要的其实是那个 -l 的参数，因为可以仅列出有在 Listen 的port

『Client 端是随机取一个大于 1024 以上的port 进行联机』，此外『只有 root 可以启动小于 1024 以下的 port 』

如果说 links 是在进行网页的『浏览』，那么 wget 就是在进行『网页数据的取得』。举例来说，我们的 Linux 核心是放置在 www.kernel.org 内，主要同时提供 ftp 与 http 来下载。我们知道可以使用 lftp 来下载资料，但如果想要用浏览器来下载呢？那就利用 wget 吧！

wget虽然功能强大，但是使用起来还是比较简单的，基本的语法是：wget [参数列表] URL。

 说实在的，对于 tcpdump 这个软件来说，你甚至可以说这个软件其实就是个黑客软件， 因为他不但可以分析封包的流向，连封包的内容也可以进行『监听』， 如果你使用的传输数据是明码的话，不得了，在 router 或 hub 上面就可能被人家监听走了！


这个 nc 指令可以用来作为某些服务的检测，因为他可以连接到某个 port 来进行沟通，此外，还可以自行启动一个 port 来倾听其他用户的联机吶！

```
GJ-vFSCP-GUK[Tue Jun 28][13:56:44]root@usp00:~# nc fs000 35002
abc
hhhhhhh
usp00
^Z
[1]+  Stopped                 nc fs000 35002
GJ-vFSCP-GUK[Tue Jun 28][14:05:22]root@usp00:~#

GJ-vFSCP-GUK[Tue Jun 28][14:03:25]root@fs000:~# nc -l fs000 35002
abc
hhhhhhh
usp00
^Z
[4]+  Stopped                 nc -l fs000 35002
```

通过杀掉进程的方法来关闭端口

每个端口都有一个守护进程，kill掉这个守护进程就可以了

每个端口都是一个进程占用着，

第一步、用下面命令

netstat -anp |grep 端口

找出占用这个端口的进程，

第二步、用下面命令

kill -9 PID

杀掉就行了

## 6.Linux网络侦错

确认 DNS 查询：利用 nslookup 或 host 或 dig 检查 www.google.com 看看；
确认 Internet 节点：可以利用 traceroute 检查各节点是否没问题？

## 7.网络安全与主机基本防护

为了避免前面一个步骤的权限误用，或者是程序有问题所造成的资安状况，因此Security Enhanced Linux (安全强化 Linux) 就来发挥它的功能啦！简单的说，SELinux 可以针对网络服务的权限来设定一些规则 (policy) ，让程序能够进行的功能有限， 因此即使使用者的档案权限设定错误，以及程序有问题时，该程序能够进行的动作还是被限制的，即使该程序使用的是 root 的权限也一样。举例来说，前一个步骤的 httpd 真的被 cracker 攻击而让对方取得 root 的使用权，由于 httpd 已经被 SELinux 控制在 /var/www/html 里面，且能够进行的功能已经被规范住了，因此 cracker 就无法使用该程序来进行系统的进一步破坏啰。现在这个 SELinux 一定要开启喔！
如此一来，我们针对控制的『主体』变成了『程序』而不是『使用者』喔！
 SELinux 并非防火墙，他是用来作为更细部权限设定的一个核心模块。
假设你需要对全世界开放 WWW ，那么提供WWW 服务的 httpd 这只程序就得要执行，并且，你的防火墙得要打开 port 80 让全世界都可以连接到你的 port 80 ，这样才是一部合理的 WWW 服务器嘛！
根据网络上面多年来的观察，很多朋友在发生权限不足方面的问题后，都会直接将某个目录直接修订成为 chmod -R 777 /some/path/。 如果这部主机只是测试用的没有上网提供服务，那还好。如果有上网提供某些服务时，那可就伤脑筋了！
 那如果由于当初规划的账号身份与群组设定的太杂乱，导致无法使用单纯的三种身份的三种权限来设定你的系统时，那该如何是好？ 没关系的，可以透过 ACL 这个好用的东西！ ACL 可以针对单一账号或单一群组进行特定的权限设定，相当好用喔！ 
如果全世界使用 CentOS 的朋友通通联机到同一部 Yum 服务器去下载所需要的 RPM 档案，哇！ 那带宽不就很容易被塞爆！那怎办？没关系，有所谓的映射站啊！ CentOS 在世界各地都有映像站，这些映像站会将官网的 yum 服务器的数据复制一份，同时在映射站上面也提供同样的 yum 功能，因此，你可以在任何一部 yum 服务器的映像站上面下载与安装软件。
我们知道浏览器默认会连接到 WWW 主机的 port 80，那么你的 WWW 是否可以启动在非 80 的其他埠口？ 当然可以啊！你可以透过 WWW 软件的设定功能将该软件使用的 port 启动在非正规的埠口， 只是如此一来，您的客户端要连接到你的主机时，就得要在浏览器的地方额外指定你所启用的非正规的埠口才行。 这个启动在非正规的端口口功能，常常被用在一些所谓的地下网站啦。另外，某些软件默认就启动在大于 1024 以上的端口口，如 MySQL 数据库软件就启动在 3306。
删除已建立或在监听当中的联机：如果想要将已经建立，或者是正在监听当中的网络服务关闭的话，最简单的方法当然就是找出该联机的 PID， 然后将他 kill 掉即可啊！

## 8.路由观念与路由设定

eth0:0 这个装置吧？这个装置可以在原本的 eth0 上面模拟出一个虚拟接口出来，以让我们原本的网络卡具有多个 IP ，具有多个 IP 的功能就被称为 IP Alias 了。而这个 eth0:0 的装置可以透过 ifconfig或 ip 这两个指令来达成
基本上，除非有特殊需求，否则建议你要有多个 IP 时，最好在不同的网卡上面达成
一般来说，不应该设定同一的网段的不同 IP 在同一部主机上面。

 那么路由器的功能
可以如何达成呢？目前有两种方法可以达成：
 硬件功能：例如 Cisco, TP-Link, D-Link (注 2) 等公司都有生产硬件路由器， 这些路由器内有嵌入式的操作系统，可以负责不同网域间的封包转译与转递等功能；
 软件功能：例如 Linux 这个操作系统的核心就有提供封包转递的能力。

了解了路由器之后，接下来你可能需要了解到什么是 **NAT (**Network Address Translation, 网络地址转换) 服务器，NAT 是啥？其实 IP 分享器就是最简单的 NAT 服务器啦！嘿嘿，了解了吗？没错， NAT 可以达成 IP 分享的功能， 而 NAT 本身就是一个路由器，只是 NAT 比路由器多了一个『 IP 转换』的功能。
一般来说，路由器会有两个网络接口，透过路由器本身的 IP 转递功能让两个网域可以互相沟通网络封包。那如果两个接口一边是公共 IP (public IP) 但一边是私有 IP (private IP) 呢？ 由于私有 IP 不能直接与公共 IP 沟通其路由信息，此时就得要额外的『 IP 转译』功能了
Linux 的 NAT 服务器可以透过修改封包的 IP 表头数据之来源或目标 IP ，让来自私有 IP 的封包可以转成 NAT 服务器的公共 IP ，就可以连上Internet ！

目前常见的动态路由协议有：RIPv1, RIPv2, OSPF, BGP 等。

## 9.防护墙与NAT服务器

我们这个章节主要在介绍 Linux 系统本身提供的软件防火墙的功能，那就是 Netfilter 。至于 TCP Wrappers 虽然在基础篇的第十八章认识系统服务里面谈过了，我们这里还会稍微简单的介绍啦！
Netfilter (封包过滤机制) :由于这种方式可以直接分析封包表头数据，所以包括硬件地址(MAC), 软件地址 (IP), TCP, UDP, ICMP 等封包的信息都可以进行过滤分析的功能，因此用途非常的广泛。(其实主要分析的是OSI 七层协议的 2, 3, 4 层啦) 
在 Linux 上面我们使用核心内建的 Netfilter 这个机制，而 Netfilter 提供了 iptables 这个软件来作为防火墙封包过滤的指令。由于 Netfilter 是核心内建的功能，因此他的效率非常的高！ 非常适合于一般小型环境的设定呢！

一般 proxy 主机通常仅开放 port 80, 21, 20 等 WWW 与 FTP 的埠口而已，而且通常 Proxy 就架设在路由器上面，因此可以完整的掌控局域网络内的对外联机！

防火墙的设定主要使用的就是 iptables 这个指令而已。而防火墙是系统管理员的主要任务之一， 且对于系统的影响相当的大，因『只能让 root 使用 iptables 』，不论是设定还是观察防火墙规则喔！

我们在前一章谈到所谓的阻断式服务 (DoS) 攻击法当中的一种方式，就是利用 TCP 封包的 SYN 三向交握原理所达成的， 这种方式称为 SYN Flooding 。那如 何预防这种方式的攻击呢？我们可以启用核心的 SYN Cookie 模块啊！ 这个 SYN Cookie 模块可以在系统用来启动随机联机的埠口 (1024:65535) 即将用完 时自动启动。

鸟哥还 是比较偏好使用脚本来撰写防火墙， 然后透过最终的 /etc/init.d/iptables save 来 将结果储存到 /etc/sysconfig/iptables 去！ 而且此一特色还可以用在呼叫其他的 scripts ，可以让防火墙规则具有较为灵活的使用方式。

NAT 服务器与路由器有啥不同？基本上，NAT 服务器一定是路由器， 不过， NAT 服务器由于会修改 IP 表头数据， 因此与单纯转递封 包的路由器不同。。最常见的 IP 分享器就是一个路由器，但是这个 IP 分享器一定会有一个 Public IP 与一个 Private IP，让 LAN 内 的 Private IP 可以透过 IP 分享器的 Public IP 传送出去喔！至 于路由器通常两边都是 Public IP 或同时为 Private IP。

你的 NAT 服务器必须要有一个 public IP 接口， 以及一个内部 LAN 连接的 private IP 接口才行。底下的范例中，鸟哥的假设是这样 的： 

 外部接口使用 eth0 ，这个接口具有 public IP 喔； 

 内部接口使用 eth1 ，假设这个 IP 为 192.168.100.254 ；

你的 Linux 就拥有主机防火墙以及 NAT 服务器的功能了

防火墙依据封包抵挡的阶层，可以分为 Proxy 以及 IP Filter (封包过滤)  两种类型；
